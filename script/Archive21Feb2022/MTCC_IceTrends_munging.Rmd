---
title: "MTCC_IceTrends_munging"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=4, fig.height=4) 
library(GGally)
library(ggcorrplot)
library(scales)
library(ggplot2)
library(patchwork)
library(lubridate)
#load packages necessary for GAMS
library("mgcv")
library("scam")
library("cowplot")
library("grid")                         # for unit.pmax(), unit.list()
library("schoenberg")
library("tidyr")
library("nlme")
library("Hmisc") #correlation matrices
library("dplyr")
library("lfstat") #for water_year function

MohonkIce<-read.csv("data/exported/MohonkIce.csv")
MohonkDailyWeatherFull<-read.csv("data/exported/MohonkDailyWeatherFull.csv")

```

File created by IAO on 10 February 2021 to document my workflow. I created a gigantic dataframe of predictor variables that we can use for Random Forest modeling of Ice-In and Ice-Out day.


## Hydro.day function

Function for calculating water-year DOY. This will help facilitate plotting and analysizing trends in ice-in since they span either side of the winter-year (e.g., 2011-2012). For example, an IceInDayofYear_fed value of 150 means Ice-In occured 150 days after the start of the water-year (Oct1)

```{r, warning=FALSE, error=FALSE, message=FALSE}
hydro.day = function(x, start.month = 10L){
  start.yr = year(x) - (month(x) < start.month)
  start.date = make_date(start.yr, start.month, 1L)
  as.integer(x - start.date + 1L)
}

MohonkIce<-MohonkIce %>%
  mutate(IceInDayofYear_fed=hydro.day(IceInDate),
         IceOutDayofYear_fed=hydro.day(IceOutDate))
```

I would recommend using IceInDayofYear_fed instead of IceInDayofYear as a response variable, otherwise you have a handful of observations with very low DOY:

```{r, warning=FALSE, error=FALSE, message=FALSE, echo=FALSE}
MohonkIce%>%
  ggplot(aes(x=Year,y=IceInDayofYear))+
  geom_point(size=3, shape=21, fill="white")


```

## Predictor variable wrangling
Starting with the 'MohonkDailyWeatherFull' dataframe which has daily min, mean, max temps and precip as snow or rain, I created a dataframe with monthly to seasonal cumulative metrics. Code below so you can see how each variable is calculated.

```{r, warning=FALSE, error=FALSE, message=FALSE}

MohonkDailyWeather_monthly <- MohonkDailyWeatherFull %>%
  mutate(
    year=year(Date),
    month=month(Date),
    month_name=month(Date, label=TRUE),
    water_year = ifelse(month %in% c("1","2","3","4"),
                        year-1, 
                        year)) %>% #this water_year term is only relevent for winter
                                   #metrics. We want 1 Oct-30 April to all correspond to the same water year
  
  filter(!month %in% c("5","6","7","8"))%>%
  #exclude May-August, which are *most likely* not directly influencing winter ice phenology
  
  group_by(water_year, month_name)%>%
  
  dplyr::summarize(cumMeanDailyT=sum(TempMean_degC, na.rm=TRUE),
            cumSnow=sum(Snow_mm, na.rm=TRUE),
            cumRain=sum(Precip_mm, na.rm=TRUE),
            percPrecipRain=(cumRain/(cumRain+cumSnow))*100,
            nDaysMeanBelowZero=sum(TempMean_degC < 0, na.rm=TRUE),
            nDaysMinBelowZero=sum(TempMin_degC < 0, na.rm=TRUE)) %>%
  
  pivot_wider(names_from="month_name",
              names_sep="_",
              values_from = c("cumMeanDailyT","cumSnow","cumRain",
                              "percPrecipRain","nDaysMeanBelowZero",
                              "nDaysMinBelowZero")) %>%
  #Convert dataframe from long to wide format
  
  mutate(##Predictors probably more relevant for ice-on DOY 
         cumMeanDailyT_SepOct=cumMeanDailyT_Sep+cumMeanDailyT_Oct,
         cumMeanDailyT_SepOctNov=cumMeanDailyT_Sep+cumMeanDailyT_Oct+cumMeanDailyT_Nov,
         cumMeanDailyT_OctNov=cumMeanDailyT_Oct+cumMeanDailyT_Nov,
         cumMeanDailyT_OctNovDec=cumMeanDailyT_Oct+cumMeanDailyT_Nov+cumMeanDailyT_Dec,
         
         cumSnow_OctNov=cumSnow_Oct+cumSnow_Nov,
         cumSnow_OctNovDec=cumSnow_Oct+cumSnow_Nov+cumSnow_Dec,
         
         cumRain_SepOct=cumRain_Sep+cumRain_Oct,
         cumRain_SepOctNov=cumRain_Sep+cumRain_Oct+cumRain_Nov,
         cumRain_OctNov=cumRain_Oct+cumRain_Nov,
         cumRain_OctNovDec=cumRain_Oct+cumRain_Nov+cumRain_Dec,
         
         nDaysMeanBelowZero_SepOct=nDaysMeanBelowZero_Sep+nDaysMeanBelowZero_Oct,
         nDaysMeanBelowZero_SepOctNov=nDaysMeanBelowZero_Sep+nDaysMeanBelowZero_Oct+nDaysMeanBelowZero_Nov,
         nDaysMeanBelowZero_OctNov=nDaysMeanBelowZero_Oct+nDaysMeanBelowZero_Nov,
         nDaysMeanBelowZero_OctNovDec=nDaysMeanBelowZero_Oct+nDaysMeanBelowZero_Nov+nDaysMeanBelowZero_Dec,
         
         nDaysMinBelowZero_SepOct=nDaysMinBelowZero_Sep+nDaysMinBelowZero_Oct,
         nDaysMinBelowZero_SepOctNov=nDaysMinBelowZero_Sep+nDaysMinBelowZero_Oct+nDaysMinBelowZero_Nov,
         nDaysMinBelowZero_OctNov=nDaysMinBelowZero_Oct+nDaysMinBelowZero_Nov,
         nDaysMinBelowZero_OctNovDec=nDaysMinBelowZero_Oct+nDaysMinBelowZero_Nov+nDaysMinBelowZero_Dec,
         
         ##Predictors probably more relevant for ice-off DOY 
         cumMeanDailyT_MarApr=cumMeanDailyT_Mar+cumMeanDailyT_Apr,
         cumMeanDailyT_FebMarApr=cumMeanDailyT_Feb+cumMeanDailyT_Mar+cumMeanDailyT_Apr,
         cumMeanDailyT_FebMar=cumMeanDailyT_Feb+cumMeanDailyT_Mar,
         cumMeanDailyT_JanFebMar=cumMeanDailyT_Jan+cumMeanDailyT_Feb+cumMeanDailyT_Mar,
         
         cumSnow_MarApr=cumSnow_Mar+cumSnow_Apr,
         cumSnow_FebMarApr=cumSnow_Feb+cumSnow_Mar+cumSnow_Apr,
         cumSnow_FebMar=cumSnow_Feb+cumSnow_Mar,
         cumSnow_JanFebMar=cumSnow_Jan+cumSnow_Feb+cumSnow_Mar,

         cumRain_MarApr=cumRain_Mar+cumRain_Apr,
         cumRain_FebMarApr=cumRain_Feb+cumRain_Mar+cumRain_Apr,
         cumRain_FebMar=cumRain_Feb+cumRain_Mar,
         cumRain_JanFebMar=cumRain_Jan+cumRain_Feb+cumRain_Mar,

         nDaysMeanAboveZero_MarApr=61-(nDaysMeanBelowZero_Mar+nDaysMeanBelowZero_Apr),
         nDaysMeanAboveZero_Mar=31-nDaysMeanBelowZero_Mar,
         nDaysMeanAboveZero_FebMar=59-(nDaysMeanBelowZero_Feb+nDaysMeanBelowZero_Mar),
         
         nDaysMinAboveZero_MarApr=61-(nDaysMinBelowZero_Mar+nDaysMinBelowZero_Apr),
         nDaysMinAboveZero_Mar=31-nDaysMinBelowZero_Mar,
         nDaysMinAboveZero_FebMar=59-(nDaysMinBelowZero_Feb+nDaysMinBelowZero_Mar),

         Year=water_year+1) %>% #year = the year of ice-off
  
  ungroup()%>%
  
  left_join(.,MohonkIce, by="Year") %>%
        #join MohonkIce dataframe with ice on/off days
  
  select(-IceOutDayofYear_fed,
         -IceInDate,-IceOutDate,-IceInDate) %>%
        # get rid of unnecessary columns
  
  select(Year, water_year, IceInDayofYear, IceOutDayofYear,
         LengthOfIceCover_days, IceInDayofYear_fed, everything()) 
        #moves select response variables to 
        #front of dataframe, then lists the rest of predictor variables.
```

Calculated some snow predictors in a separate dataframe, then joined with MohonkDailyWeather_monthly
```{r, warning=FALSE, error=FALSE, message=FALSE}
SnowPredictors<-MohonkDailyWeatherFull %>%
  mutate(
    year=year(Date),
    month=month(Date),
    month_name=month(Date, label=TRUE),
    water_year = ifelse(month %in% c("1","2","3","4"),
                        year-1, 
                        year)) %>% #this water_year term is only relevent for winter
  #metrics. We want 1 Oct-30 April to all correspond to the same water year
  #exclude May-August, which are *most likely* not directly influencing winter ice phenology
  filter(!water_year==1929)%>%
  group_by(water_year)%>%
  dplyr::summarize(maxSnowDepth_mm = max(SnowDepth_mm),
            datemaxSnowDepth = Date[which(SnowDepth_mm == max(SnowDepth_mm))],
            maxSnowDepthDOY_fed=hydro.day(datemaxSnowDepth)) %>%
  select(-datemaxSnowDepth)


MohonkDailyWeather_monthly<-left_join(MohonkDailyWeather_monthly,SnowPredictors, by="water_year")
  

```

# Reducing predictor variables
We end up with a dataframe of 91 observations and 92 predictors. I looked at all the pairwise correlations > 0.8 and made decisions to cut some variables (I kept track of my reasoning in MTCC_Analysis_icetrends.R).

#### But note the following predictor variables are highly correlated, but I wasn't sure which to stick with. Probably should just keep one or the other in the initial RF runs and see if either come out?

<style type="text/css">
.table {

    width: 60%;

}
</style>

Variable pair | r
------------- | -------------
nDaysMeanBelowZero_Dec &	nDaysMinBelowZero_Dec |	0.86
cumMeanDailyT_Mar &	nDaysMinAboveZero_Mar	| 0.86
cumMeanDailyT_MarApr &	nDaysMinAboveZero_MarApr |	0.86
cumMeanDailyT_Mar	& nDaysMeanAboveZero_Mar |	0.83



#### Statistically significant, but potentially spurious, correlations to be aware of:
<style type="text/css">
.table {

    width: 60%;

}
</style>
IceInDayofYear_fed |	
------------- | -------------
&nbsp; | nDaysMeanBelowZero_Jan
&nbsp; |	nDaysMeanBelowZero_Mar
&nbsp; |	nDaysMeanAboveZero_FebMar
&nbsp; |	nDaysMeanAboveZero_Mar
&nbsp; |	cumSnow_Jan
&nbsp; |	cumMeanDailyT_Jan
&nbsp; |	percPrecipRain_Jan

#### Again, many statistically significant correlations with IceOutDayofYear, but Iâ€™m not sure if we can make sense of all of them. Some that stick out and to be aware of: 
<style type="text/css">
.table {

    width: 60%;

}
</style>
IceOutDayofYear |	
------------- | -------------
&nbsp; | IceInDayofYear_fed (interesting!)
&nbsp; |	cumMeanDailyT_OctNovDec
&nbsp; |	cumSnow_Oct
&nbsp; |	cumMeanDailyT_Dec
&nbsp; |	nDaysMinBelowZero_Dec
&nbsp; |	nDaysMinBelowZero_Nov
&nbsp; |	cumSnow_Dec (could influence ice clarity?)
&nbsp; |	percPrecipRain_Oct
&nbsp; |	nDaysMeanBelowZero_Jan (could influence ice thickness?
&nbsp; |	nDayMinBelowZero_OctNovDec (same as above)

